# План рефакторинга: Gateway Service (Шлюз)

**Цель**: Реализовать синергию между ретраями сервера и сменой ключа.

## 1. Обновление конфигурации (`src/config/schemas.py`)
В `RetryOnErrorConfig` (секция `retry.on_key_error`) добавить параметры для масштабирования (Backoff), аналогично секции `on_server_error`:
- `backoff_sec`: float (def: 0.1)
- `backoff_factor`: float (def: 1.5)
Это защитит БД от шквала запросов при массовом падении ключей ("Key Storm").

## 2. Логика Gateway (`src/services/gateway_service.py`)

### 2.1. Автоматические фиксы (из Phase 0)
- Ошибки `INVALID_KEY`, `NO_QUOTA` больше не считаются retryable.
- Шлюз (даже в старом коде) пойдет в ветку удаления ключа. Это уже решено.

### 2.2. Обработка 400 (Bad Request)
- Подтвердить тестами, что 400 по умолчанию — это `is_client_error()`, ретраев нет, пенальти нет.
- Исключение: Если сработал `unsafe_status_mapping` или `error_parsing`, маппящий 400 в `INVALID_KEY` → тогда работает логика фатальной ошибки (п. 2.3).

### 2.3. Синергия Ретраев (Новая логика)

Модифицировать `_handle_buffered_retryable_request`. Логика вложенных циклов или переходов состояний:

**Этап А: Попытка запроса с Текущим Ключом**
1. Отправляем запрос.
2. **Успех (200)**: Возврат клиенту.
3. **Фатальная ошибка (Fatal)**: 
   - Сразу **Пенальти** текущему ключу.
   - Переход к Этапу Б (Смена ключа).
4. **Ошибка Сервера (Server Error/Rate Limit)**:
   - Запуск цикла ретраев (`on_server_error.attempts`).
   - Пауза (backoff).
   - Повтор с **ТЕМ ЖЕ** ключом.
   - **Если попытки сервера исчерпаны**:
     - **Пенальти** текущему ключу (мы пытались, он не смог).
     - Переход к Этапу Б (Смена ключа).

**Этап Б: Смена ключа (Key Rotation Loop)**
- Этот цикл управляется `on_key_error.attempts`.
- Каждый раз, когда мы попадаем сюда (из-за Фатальной ошибки или исчерпания серверных попыток):
  - Применяем Backoff (новые параметры из п.1).
  - Берем **НОВЫЙ** ключ из пула.
  - Возвращаемся на Этап А с новым ключом.

## 3. Тестирование
- **Test 1: Server Retry Fail -> New Key**. (500 x N) -> (New Key) -> 200.
- **Test 2: Key Storm Protection**. Проверка, что при смене ключей работает backoff.
- **Test 3: Unsafe 400 Fatal**. 400 mapped to Invalid Key -> Пенальти -> New Key.
